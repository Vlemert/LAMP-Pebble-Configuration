<!DOCTYPE html>
<html>
<head>
    <title></title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/js/hue.js"></script>

    <link rel="stylesheet" type="text/css" href="css/style.css" media="all" />
</head>
<body>
    <div class="appHeader">
        <div class="backArrow startHidden" id="backArrow">
            <
        </div>
        L.A.M.P.
    </div>
    <div id="window_setupConnection_1" class="window">
        <h1>Welcome to the L.A.M.P. configuration</h1>
        <p>
            It appears that this is the first time you launch L.A.M.P. Follow the steps and I will guide you through the process.
        </p>
        <div class="window_buttons">
            <div id="button_setupConnection_1_next">Next</div>
        </div>
    </div>

    <div id="window_setupConnection_2" class="window">
        <h1>Connecting with your Hue bridge</h1>
        <p>
            First we need to connect with your bridge. You do this by pressing the connect button below and the center button on your bridge.
        </p>
        <p>
            The order doesn't matter, just make sure you press both buttons within 30 seconds.
        </p>
        <div id="button_register_bridge">
            Connect
        </div>
        <div id="window_waitingforbridge" class="startHidden">
            Waiting for the bridge button to be pressed...
        </div>
    </div>

    <div id="window_setupConnection_3" class="window">
        <h1>Succesfully connected to the bridge!</h1>
        <p>
            We have successfully set up a connection! Press the next button to configure your lights, groups and blueprints. Have fun!
        </p>
        <div class="window_buttons">
            <div id="button_setupConnection_3_next">Next</div>
        </div>
    </div>

    <div id="window_lights" class="window" parentWindow="window_mainMenu">
        <ul id="lightsList" class="lamps">
            <li>Loading...</li>
        </ul>
    </div>

    <div id="window_connection" class="window" parentWindow="window_mainMenu">
        <div class="menuItem" id="menuItem_ResetConnection">
            <div class="menuArrow">
                >
            </div>
            Reset
        </div>
    </div>

    <div id="window_groups" class="window" parentWindow="window_mainMenu">
        <ul id="groupList" class="groups">
            <li>Loading...</li>
        </ul>
        <div id="addNewGroup">
            Add new group
        </div>
        <div id="addNewGroupPanel" class="window">
            <input type="text" class="field" id="tbAddNewGroup" />
            <div class='save' id="saveNewGroup">save</div>
        </div>
    </div>

    <div id="window_editGroupLights" class="window" parentWindow="window_groups">
        <div class="separator">
            In this group (click to remove)
        </div>
        <ul id="groupLightsIncludedList" class="groupLights">
            <li>Loading...</li>
        </ul>
        <div class="separator">
            Not in this group (click to add)
        </div>
        <ul id="groupLightsExcludedList" class="groupLights">
            <li>Loading...</li>
        </ul>
    </div>

    <div id="window_mainMenu" class="window">
        <div class="menuItem windowAction" id="menuItem_lights" targetWindow="window_lights">
            <div class="menuArrow">
                >
            </div>
            Lights
        </div>
        <div class="menuItem windowAction" id="menuItem_groups" targetWindow="window_groups">
            <div class="menuArrow">
                >
            </div>
            Groups
        </div>
        <div class="menuItem windowAction">
            <div class="menuArrow">
                >
            </div>
            Blueprints
        </div>
        <div class="menuItem windowAction">
            <div class="menuArrow">
                >
            </div>
            Presets
        </div>
        <div class="menuItem windowAction" id="menuItem_connection" targetWindow="window_connection">
            <div class="menuArrow">
                >
            </div>
            Connection
        </div>
        <div class="menuItem windowAction" id="menuItem_save">
            <div class="menuArrow">
                >
            </div>
            Save settings
        </div>
    </div>

    <span id="textLabel"></span>

    <script>
        // vars
        var discoveredBridges = [];

        // TODO:
        // At launch check app version (in call url), if version mismatch then redirect users to the store
        // What do we do with iOS users who won't be able to update instantly?


        // temp: clear config
        //localStorage.clear();

        // At launch, we check if there is a lamp configuration set
        if (window.localStorage.lampConfiguration && JSON.parse(window.localStorage.lampConfiguration).bridgeIp && JSON.parse(window.localStorage.lampConfiguration).bridgeId && JSON.parse(window.localStorage.lampConfiguration).bridgeUsername) {
            // Configuration is available and complete (as far as the bridge connection concerns)
            $('#window_mainMenu').addClass('current');
        } else {
            // Configuration has not been setup
            $('#window_setupConnection_1').addClass('current');

            // Find local bridge(s)
            discoverBridges(function(e) {
                discoveredBridges = JSON.parse(e);
            });
        }


        $('#button_setupConnection_1_next').click(function() {
            // show the next setup screen
            $('#window_setupConnection_1').removeClass('current');
            $('#window_setupConnection_2').addClass('current');
        });

        $('#button_register_bridge').click(function() {
            // Hide the register bridge button so users dont spam, show waiting for bridge label
            $('#button_register_bridge').hide();
            $('#window_waitingforbridge').show();

            // Start polling the hue(s), try to register
            for (i = 0; i < discoveredBridges.length; i++) {
                bridgePoll(i);
            }
        });

        function rebindWindowActions() {
            // Centralized windowAction button handler
            $('.windowAction').click(function() {
                // Hide all windows
                $('.window').removeClass('current');

                // Find and show the target
                var targetName = $(this).attr('targetWindow');
                var target = $('#' + targetName);
                target.addClass('current');

                switch(targetName)
                {
                    case "window_lights":
                        loadLights();
                        break;
                    case "window_groups":
                        rebindGroups();
                        break;
                    case "window_connection":
                    // No extra code execution required
                    case "window_editGroupLights":
                        var parent = $(this).closest('li');

                        getLights(function(e) {
                            var allLights = JSON.parse(e);

                            var groupId = parent.attr('groupId');

                            rebindGroupLights(allLights, groupId);
                        });
                    default:
                    // Do nothing..
                }

                // Get the target's parent, if there is one, show the back arrow
                var parentWindow = target.attr('parentWindow');
                if (parentWindow) {
                    $('#backArrow').show();
                } else {
                    $('#backArrow').hide();
                }
            });
        }

        $('#menuItem_save').click(function() {
            // Return config to pebble js
            window.location.href = "pebblejs://close#" + encodeURIComponent(JSON.stringify(window.localStorage.lampConfiguration));
        });

        function rebindGroups() {
            // Load groups from the config (if there are any)
            var config = JSON.parse(window.localStorage.lampConfiguration);
            if (config.groups && config.groups.length > 0) {
                var groupsHtml = "";
                for (i = 0; i < config.groups.length; i++) {
                    groupsHtml += "<li groupId='" + i + "'><div class='windowAction editlights' targetWindow='window_editGroupLights'>L</div><div class='delete'>X</div>" + config.groups[i].name + "</li>";
                }
                $('#groupList').html(groupsHtml);
            } else {
                $('#groupList').html("<li>Group list empty</li>");
            }

            $('.groups .delete').click(function() {
                var parent = $(this).closest('li');
                var groupId = parent.attr('groupId');

                var config = JSON.parse(window.localStorage.lampConfiguration);
                config.groups.splice(groupId, 1);
                window.localStorage.lampConfiguration = JSON.stringify(config);

                rebindGroups();
            });

            rebindWindowActions();
        }

        function rebindGroupLights(allLights, groupId) {
            var config = JSON.parse(window.localStorage.lampConfiguration);

            var lightIdsInGroup = [];

            var groupLightsIncludedList = $('#groupLightsIncludedList');

            if(config.groups[groupId].lights && config.groups[groupId].lights.length > 0) {
                var groupLightsIncludedHtml = "";

                for (i = 0; i < config.groups[groupId].lights.length; i++) {
                    groupLightsIncludedHtml += "<li lightIndex='" + i + "' lightId='" + config.groups[groupId].lights[i].id + "'>" + config.groups[groupId].lights[i].name + "</li>";

                    lightIdsInGroup[lightIdsInGroup.length] = config.groups[groupId].lights[i].id;
                }

                groupLightsIncludedList.html(groupLightsIncludedHtml);
            } else {
                groupLightsIncludedList.html("<li>No lights in this group</li>");
            }

            var groupLightsExcludedHtml = "";

            for (i = 0; i < 50; i++) {
                if (allLights[i] != null && $.inArray(i.toString(), lightIdsInGroup) == -1) {
                    groupLightsExcludedHtml += "<li lightId='" + i + "'>" + allLights[i].name + "</li>"
                }
            }

            var groupLightsExcludedList = $('#groupLightsExcludedList');

            groupLightsExcludedList.html(groupLightsExcludedHtml);

            groupLightsIncludedList.find('li').click(function() {
                var lightIndex = $(this).attr('lightIndex');

                var config = JSON.parse(window.localStorage.lampConfiguration);

                config.groups[groupId].lights.splice(lightIndex, 1);

                window.localStorage.lampConfiguration = JSON.stringify(config);

                rebindGroupLights(allLights, groupId);
            });

            groupLightsExcludedList.find('li').click(function() {
                var lightId = $(this).attr('lightId');

                getLights(function(e) {
                    var config = JSON.parse(window.localStorage.lampConfiguration);

                    if(!config.groups[groupId].lights) {
                        config.groups[groupId].lights = [];
                    }

                    config.groups[groupId].lights[config.groups[groupId].lights.length] = {
                        id: lightId,
                        name: allLights[lightId].name
                    };

                    window.localStorage.lampConfiguration = JSON.stringify(config);

                    rebindGroupLights(allLights, groupId);

                    blinkLightSingle(lightId, function(e) {

                    });
                });
            });
        }

        $('#addNewGroup').click(function() {
            $(this).hide();
            var addNewGroupPanel = $('#addNewGroupPanel');
            addNewGroupPanel.show();
            addNewGroupPanel.find('input').focus();
        });

        $('#saveNewGroup').click(function() {
            var config = JSON.parse(window.localStorage.lampConfiguration);

            if(!config.groups) {
                config.groups = [];
            }

            config.groups[config.groups.length] = {
                name: $('#tbAddNewGroup').val()
            };

            window.localStorage.lampConfiguration = JSON.stringify(config);

            rebindGroups();

            $('#addNewGroupPanel').hide();
            $('#addNewGroup').show();
        });

        $('#menuItem_ResetConnection').click(function() {
            // Reset the brigdge connection
            var config = JSON.parse(window.localStorage.lampConfiguration);
            config.bridgeIp = null;
            config.bridgeId = null;
            config.bridgeUsername = null;
            window.localStorage.lampConfiguration = JSON.stringify(config);

            // Redirect the user to the bridge setup screen
            $('#window_setupConnection_2').show();
            $('#window_connection').hide();
        });

        function loadLights() {
            getLights(function(e) {
                locatedLights = JSON.parse(e);

                var lightListHtml = "";

                for (i = 1; i < 50; i++) {
                    if (locatedLights[i] == null) {
                        break;
                    }
                    lightListHtml += "<li lightid='" + i + "'><div class='rename'>rename</div><div class='save startHidden'>save</div><span class='label'>" + locatedLights[i].name + "</span><div class='fieldContainer'><input type='text' class='field startHidden' /></div></li>";
                }

                $('#lightsList').html(lightListHtml);

                $('.rename').click(function() {
                    var parent = $(this).closest('li');
                    $('.rename').hide();
                    $('.save', parent).show();

                    var label = $('.label', parent);
                    var field = $('.field', parent);
                    label.hide();
                    field.show();
                    field.val(label.text());
                    field.focus();

                    // start blinking the light
                    var lightid = parent.attr('lightid');
                    blinkLight(lightid, function(e) {

                    });
                });

                $('.save').click(function() {
                    var parent = $(this).closest('li');
                    $('.rename').show();
                    $('.save', parent).hide();

                    var label = $('.label', parent);
                    var field = $('.field', parent);
                    label.show();
                    field.hide();
                    label.text(field.val());


                    var lightid = parent.attr('lightid');
                    renameLight(lightid, field.val(), function(e) {

                    });


                    // stop blinking the light
                    stopBlinkLight(lightid, function(e) {

                    });
                });
            });
        }

        $('#backArrow').click(function() {
            // Get the current window
            var currentWindow = $('.window.current');

            // Get it's parent window
            var parentWindowId = currentWindow.attr('parentWindow');
            var parentWindow = $('#' + parentWindowId);

            // Hide all windows
            $('.window').removeClass('current');

            // Show parent window
            parentWindow.addClass('current');

            // Check if parent window has a parent, if so, show the back arrow, hide otherwise
            if (parentWindow.attr('parentWindow')) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });

        var connectedToBridge = false;

        function bridgePoll(i) {
            tryRegister(discoveredBridges[i].internalipaddress, "LAMP for Pebble", function(e) {
                var response = JSON.parse(e);

                // TODO: Possibility for more than one error...
                if (response[0].error != null) {
                    //document.getElementById("registerResponse").innerHTML = response[0].error.description;
                    //alert(xmlhttp.responseText);
                    if(!connectedToBridge) {
                        setTimeout(function() {bridgePoll(i);}, 1000);
                    }
                } else {
                    // Successfully connected to the bridge
                    connectedToBridge = true;

                    // This is the username the bridge gave us
                    var userName = response[0].success.username;

                    // Setup the configuration
                    if (window.localStorage.lampConfiguration) {
                        // Configuration is available
                        var config = JSON.parse(window.localStorage.lampConfiguration);

                        config.bridgeIp = discoveredBridges[i].internalipaddress;
                        config.bridgeId = discoveredBridges[i].id;
                        config.bridgeUsername = userName;

                        window.localStorage.lampConfiguration = JSON.stringify(config);
                    } else {
                        // No configuration, create a new one
                        window.localStorage.lampConfiguration = JSON.stringify({
                            "bridgeIp": discoveredBridges[i].internalipaddress,
                            "bridgeId": discoveredBridges[i].id,
                            "bridgeUsername": userName
                        });
                    }

                    // Show the next page
                    $('#window_setupConnection_2').hide();
                    $('#window_setupConnection_3').show();
                }
            });
        }

        //window.localStorage.lampConfiguration = {"bridgeid": "test"};
        //document.getElementById("textLabel").innerText = window.localStorage.lampConfiguration;


        rebindWindowActions();
    </script>
</body>


</html>